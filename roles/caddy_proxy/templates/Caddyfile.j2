{
        email {{ caddy_admin_email }}
        acme_ca {{ internal_ca_url }}
        acme_ca_root /etc/caddy/pki/root_ca.crt
        # оставим авто-редиректы включёнными по умолчанию
}

(security_headers) {
        header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
                X-Content-Type-Options "nosniff"
                Referrer-Policy "no-referrer-when-downgrade"
                Permissions-Policy "geolocation=(), microphone=(), camera=()"
                Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; media-src 'self' data: blob:; font-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; connect-src 'self' https://{{ nextcloud_fqdn }} https://{{ onlyoffice_fqdn }} https://{{ auth_fqdn }} wss://{{ onlyoffice_fqdn }}; frame-ancestors 'self' https://{{ auth_fqdn }} https://{{ nextcloud_fqdn }}; frame-src 'self' https://{{ onlyoffice_fqdn }} https://{{ auth_fqdn }};"
        }
}

# Authentik
{{ auth_fqdn }} {
        import security_headers
        reverse_proxy http://{{ authentik_upstream }} {
                health_checks {
                        active {
                                path /-/health/ready/
                                interval 15s
                                timeout 2s
                        }
                }
        }
}

# Nextcloud
{{ nextcloud_fqdn }} {
        import security_headers
        encode zstd gzip
        rewrite /.well-known/carddav /remote.php/dav
        rewrite /.well-known/caldav /remote.php/dav
        reverse_proxy http://{{ nextcloud_upstream }} {
                health_checks {
                        active {
                                path /status.php
                                interval 15s
                                timeout 2s
                        }
                }
        }
}

# OnlyOffice
{{ onlyoffice_fqdn }} {
        import security_headers
        reverse_proxy http://{{ onlyoffice_upstream }} {
                health_checks {
                        active {
                                path /healthcheck
                                interval 15s
                                timeout 2s
                        }
                }
        }
}
