---
- name: Ensure Authentik project dir
  ansible.builtin.file:
    path: "{{ authentik_project_path }}"
    state: directory
    mode: '0755'

- name: Ensure Authentik data directories
  ansible.builtin.file:
    path: "{{ authentik_project_path }}/{{ item }}"
    state: directory
    mode: '0750'
  loop:
    - postgres
    - redis
    - media
    - config

# Предполагаем, что шаблон уже есть в роли:
# roles/authentik/templates/docker-compose.yml.j2
- name: Render Authentik docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ authentik_project_path }}/{{ authentik_compose_file }}"
    mode: '0644'
  notify: Apply Authentik stack

- name: Ensure Authentik stack is running  # noqa command-instead-of-module
  ansible.builtin.command:
    cmd: >-
      docker compose -f {{ authentik_compose_file }}
      up -d --remove-orphans
      {% if authentik_compose_pull in ['missing', 'always'] %}
      --pull {{ authentik_compose_pull }}
      {% endif %}
  args:
    chdir: "{{ authentik_project_path }}"
  register: authentik_compose
  failed_when: authentik_compose.rc != 0
  changed_when: >-
    authentik_compose.rc == 0 and (
      authentik_compose.stdout is search(
        '(?i)(Creating|Recreating|Starting|Started|Pulling|Downloading|Building|Removing)'
      )
      or authentik_compose.stderr is search(
        '(?i)(Creating|Recreating|Starting|Started|Pulling|Downloading|Building|Removing)'
      )
    )
