services:
  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    command:
      - "--transaction-isolation=READ-COMMITTED"
      - "--binlog-format=ROW"
      - "--innodb-file-per-table=1"
      - "--innodb_large_prefix=on"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_general_ci"
    environment:
      MYSQL_ROOT_PASSWORD: "{{ nc_db_root_password }}"
      MYSQL_DATABASE: "{{ nc_db_name | default('nextcloud') }}"
      MYSQL_USER: "{{ nc_db_user | default('nextcloud') }}"
      MYSQL_PASSWORD: "{{ nc_db_password }}"
      MARIADB_AUTO_UPGRADE: "1"
      MARIADB_DISABLE_UPGRADE_BACKUP: "1"
    volumes:
      - ./db:/var/lib/mysql
    networks:
      - infra
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  nextcloud-redis:
    image: redis:7-alpine
    container_name: nextcloud-redis
    command:
      - "redis-server"
      - "--save"
      - ""
      - "--appendonly"
      - "no"
    volumes:
      - ./redis:/data
    networks:
      - infra
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  nextcloud-app:
    image: nextcloud:27-apache
    container_name: nextcloud-app
    depends_on:
      nextcloud-db:
        condition: service_healthy
      nextcloud-redis:
        condition: service_healthy
    environment:
      MYSQL_DATABASE: "{{ nc_db_name | default('nextcloud') }}"
      MYSQL_USER: "{{ nc_db_user | default('nextcloud') }}"
      MYSQL_PASSWORD: "{{ nc_db_password }}"
      MYSQL_HOST: "nextcloud-db"
      REDIS_HOST: "nextcloud-redis"
      PHP_MEMORY_LIMIT: "1024M"
      PHP_UPLOAD_LIMIT: "4096M"
      OVERWRITECLIURL: "https://{{ nextcloud_fqdn }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "{{ nextcloud_fqdn }} {{ base_domain }}"
      NEXTCLOUD_OVERWRITEHOST: "{{ nextcloud_fqdn }}"
      NEXTCLOUD_OVERWRITEPROTOCOL: "https"
      NEXTCLOUD_TRUSTED_PROXIES: "caddy"
      # Уберите комментарий, если увидите проблемы с IP-адресами клиентов
      # APACHE_DISABLE_REWRITE_IP: "1"
    volumes:
      - ./data:/var/www/html
      - ./apps:/var/www/html/custom_apps
      - ./config:/var/www/html/config
      - ./config/redis.config.php:/var/www/html/config/redis.config.php
    networks:
      - infra
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1/status.php || wget -q --spider http://127.0.0.1/status.php"]
      interval: 15s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  nextcloud-cron:
    image: nextcloud:27-apache
    container_name: nextcloud-cron
    entrypoint: /cron.sh
    depends_on:
      nextcloud-app:
        condition: service_started
    volumes:
      - ./data:/var/www/html
      - ./apps:/var/www/html/custom_apps
      - ./config:/var/www/html/config
      - ./config/redis.config.php:/var/www/html/config/redis.config.php
    networks:
      - infra
    restart: unless-stopped

networks:
  infra:
    external: true
    name: {{ docker_infra_network }}
