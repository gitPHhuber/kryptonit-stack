---
- name: Stop and mask auto updater services
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    masked: true
  loop:
    - packagekit
    - apt-daily.service
    - apt-daily-upgrade.service
    - unattended-upgrades.service
  register: bootstrap_apt_mask_services
  failed_when:
    - bootstrap_apt_mask_services is failed
    - >-
      'Could not find the requested service' not in
      (bootstrap_apt_mask_services.msg | default(''))
  loop_control:
    label: "{{ item }}"

- name: Force IPv4 for APT when enabled
  become: true
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/99force-ipv4
    content: 'Acquire::ForceIPv4 "true";\n'
    mode: '0644'
  when: force_ipv4_for_apt | bool

- name: Remove forced IPv4 configuration when disabled
  become: true
  ansible.builtin.file:
    path: /etc/apt/apt.conf.d/99force-ipv4
    state: absent
  when: not force_ipv4_for_apt | bool

- name: Clean apt caches and lists
  become: true
  ansible.builtin.shell: |  # noqa command-instead-of-shell
    set -e
    apt-get clean
    rm -rf /var/lib/apt/lists/*
  args:
    executable: /bin/bash
  register: bootstrap_apt_clean
  changed_when: bootstrap_apt_clean.rc == 0

- name: Update apt cache with retries and timeout
  become: true
  ansible.builtin.command:  # noqa command-instead-of-module
    cmd: "timeout {{ apt_timeout_sec | default(20) }}s apt-get update"
  register: bootstrap_apt_update
  retries: "{{ apt_retries | default(3) | int }}"
  delay: 5
  until: bootstrap_apt_update is succeeded
  changed_when: false
  environment:
    DEBIAN_FRONTEND: noninteractive
